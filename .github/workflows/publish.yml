---
# yamllint disable rule:line-length
name: "Publish to npm"

# Trigger on GitHub releases for controlled publishing
'on':
  release:
    types: [published]
  # Allow manual trigger for testing (will do a dry-run)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform dry-run (do not actually publish)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

# Minimal permissions following principle of least privilege
permissions:
  contents: read
  id-token: write  # Required for OIDC/trusted publishing and provenance

jobs:
  publish:
    name: "Publish to npm with Provenance"
    runs-on: ubuntu-latest

    # Only run on main branch to prevent accidental publishes from forks
    if: github.repository == 'mobilemind/js2uri' && (github.event_name == 'release' || github.event_name == 'workflow_dispatch')

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v5
        with:
          # Fetch full history for potential version checks
          fetch-depth: 0

      - name: "Setup Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          # Note: registry-url removed to allow OIDC/trusted publishing authentication

      - name: "Install dependencies"
        run: npm ci

      - name: "Run tests"
        run: npm test

      - name: "Security audit"
        run: npm audit --omit=dev --audit-level=moderate

      - name: "Verify package contents"
        run: |
          npm pack --dry-run
          echo "‚úì Package contents verified"

      - name: "Check package.json version matches release tag"
        if: github.event_name == 'release'
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          echo "Package version: $PACKAGE_VERSION"
          echo "Release tag: $RELEASE_TAG"

          # Strip 'v' prefix if present in tag
          RELEASE_VERSION=${RELEASE_TAG#v}

          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "‚ùå Version mismatch: package.json has $PACKAGE_VERSION but release tag is $RELEASE_TAG"
            exit 1
          fi
          echo "‚úì Version matches release tag"

      - name: "Publish to npm (dry-run)"
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == 'true'
        run: |
          echo "üß™ Dry-run mode - not actually publishing"
          npm publish --dry-run --provenance --access public
          echo "‚úì Dry-run successful - package would be published"

      - name: "Publish to npm with provenance"
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == 'false')
        run: npm publish --provenance --access public
        # No NODE_AUTH_TOKEN needed - OIDC/trusted publishing handles authentication
        # The id-token: write permission above enables this

      - name: "Verify publication"
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == 'false')
        run: |
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          echo 'Waiting 30 seconds for npm registry to update...'
          sleep 30

          echo "Verifying publication of js2uri@$PACKAGE_VERSION"
          npm view "js2uri@$PACKAGE_VERSION" version

          echo '‚úì Package successfully published and verified'
          echo "üì¶ View at: https://www.npmjs.com/package/js2uri/v/$PACKAGE_VERSION"

      - name: "Check provenance attestation"
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == 'false')
        run: |
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          echo 'Checking for provenance attestation...'
          sleep 10  # Give npm time to process attestation

          # Try to fetch provenance info (npm 9.5.0+)
          npm view "js2uri@$PACKAGE_VERSION" --json | jq -r '.publishConfig.provenance // "No provenance data yet"' || true

          echo '‚ÑπÔ∏è  Provenance attestation may take a few minutes to appear on npm'
          echo "üìã Check later at: https://www.npmjs.com/package/js2uri/v/$PACKAGE_VERSION"
